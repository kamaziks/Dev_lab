name: Deploy to DigitalOcean LAMP Server

on:
  push:
    branches: [ main ]  # ÐÐ±Ð¾ master, Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ Ð²Ñ–Ð´ Ð½Ð°Ð·Ð²Ð¸ Ð²Ð°ÑˆÐ¾Ñ— Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ñ— Ð³Ñ–Ð»ÐºÐ¸
  workflow_dispatch:  # Ð”Ð¾Ð·Ð²Ð¾Ð»ÑÑ” Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸ workflow Ð²Ñ€ÑƒÑ‡Ð½Ñƒ

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
      
      - name: PHP Lint
        run: |
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÑƒ PHP Ñ„Ð°Ð¹Ð»Ñ–Ð² (Ð¾Ð¿Ñ†Ñ–Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
          find . -name "*.php" -type f -print0 | xargs -0 php -l
      
      - name: Create deployment script
        run: |
          cat > deploy.sh << 'EOL'
          #!/bin/bash
          
          # ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ Ñ„Ð°Ð¹Ð»Ñ–Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ñ–
          rsync -avz --delete --exclude '.git' --exclude '.github' --exclude 'node_modules' ./ ${{ secrets.DIGITALOCEAN_USER }}@${{ secrets.DIGITALOCEAN_HOST }}:/var/www/html/${{ secrets.PROJECT_DIRECTORY }}/
          
          # Ð’Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–Ð¹ Ð±Ð°Ð·Ð¸ Ð´Ð°Ð½Ð¸Ñ… Ð°Ð±Ð¾ Ñ–Ð½ÑˆÐ¸Ñ… ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ–Ð² Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
          ssh ${{ secrets.DIGITALOCEAN_USER }}@${{ secrets.DIGITALOCEAN_HOST }} << 'ENDSSH'
          cd /var/www/html/${{ secrets.PROJECT_DIRECTORY }}
          
          # ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ñƒ
          find . -type f -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          
          # Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ñ–Ñ—, ÑÐºÑ– Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð·Ð°Ð¿Ð¸ÑÑƒ
          if [ -d "./storage" ]; then
            chmod -R 775 ./storage
            chown -R www-data:www-data ./storage
          fi
          
          if [ -d "./cache" ]; then
            chmod -R 775 ./cache
            chown -R www-data:www-data ./cache
          fi
          
          if [ -d "./uploads" ]; then
            chmod -R 775 ./uploads
            chown -R www-data:www-data ./uploads
          fi
          
          # Ð’Ð¸ÐºÐ¾Ð½Ð°Ð½Ð½Ñ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–Ð¹ Ð‘Ð” (ÑÐºÑ‰Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾)
          if [ -f "./migrations/migrate.php" ]; then
            php ./migrations/migrate.php
          fi
          
          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÐµÑˆÑƒ (ÑÐºÑ‰Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾)
          if [ -f "./scripts/clear_cache.php" ]; then
            php ./scripts/clear_cache.php
          fi
          
          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº/Ð¿ÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Apache
          sudo systemctl reload apache2
          
          echo "Deployment completed successfully!"
          ENDSSH
          EOL
          
          chmod +x deploy.sh
      
      - name: Deploy to LAMP server
        run: ./deploy.sh
        
      - name: Notify about deployment
        if: success()
        run: |
          echo "ðŸš€ Deployment to DigitalOcean completed successfully!"
          
      - name: Notify about failure
        if: failure()
        run: |
          echo "âŒ Deployment to DigitalOcean failed."
